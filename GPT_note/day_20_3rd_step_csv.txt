ðŸ”¥ Day 20 - ç¬¬ä¸‰éšŽæ®µä»»å‹™ï¼šæŸ¥è©¢å ±è¡¨æ•´åˆèˆ‡è³‡æ–™è¼¸å‡º
ðŸŽ¯ ç›®æ¨™ï¼š

å°‡ä½ ç¾åœ¨çš„æŸ¥è©¢çµæžœï¼ˆorders.htmlï¼‰ï¼š

    åŠ å…¥æ¢ä»¶æŸ¥è©¢

    é¡¯ç¤ºçµ±è¨ˆè³‡æ–™ï¼ˆç¸½é‡‘é¡ï¼‰

    å¯ä»¥åŒ¯å‡ºæŸ¥è©¢çµæžœç‚º CSV æˆ– Excel

âœ… å…¨æµç¨‹åˆ†è§£
ç¬¬ä¸€æ­¥ï¼šä½ å·²å®Œæˆ âœ…

    é¡¯ç¤ºè¨‚å–®é é¢ /orders

    é—œéµå­—èˆ‡æ—¥æœŸç¯©é¸

    HTML è¡¨å–®æ“ä½œèˆ‡è³‡æ–™ç¸½è¨ˆé¡¯ç¤º

ç¬¬äºŒæ­¥ï¼šæ–°å¢žã€Œä¸‹è¼‰å ±è¡¨ã€åŠŸèƒ½ ðŸ”½ï¼ˆæˆ‘å€‘æŽ¥ä¸‹ä¾†è¦åšçš„ï¼‰

é€™æ­¥æœƒè®“ä½ èƒ½åœ¨ /orders é é¢ä¸­ï¼š

    çœ‹åˆ°ã€Œä¸‹è¼‰å ±è¡¨ã€æŒ‰éˆ•

    ä¸‹è¼‰ç›®å‰ç¯©é¸éŽçš„è¨‚å–®è³‡æ–™ï¼ˆä¾æŸ¥è©¢æ¢ä»¶éŽæ¿¾ï¼‰

    å¯é¸æ“‡æ ¼å¼ï¼šCSV æˆ– Excelï¼ˆå…ˆå¾ž CSV é–‹å§‹ï¼‰

ðŸš§ ä»Šå¤©ç›®æ¨™ï¼šå…ˆå¯¦ä½œ CSV å ±è¡¨åŒ¯å‡º
æ­¥é©Ÿæ¦‚è¦½ï¼š

    æ–°å¢ž Flask è·¯ç”± /export_csv

        æŽ¥æ”¶èˆ‡ /orders ç›¸åŒçš„æŸ¥è©¢åƒæ•¸

        ç¯©é¸è³‡æ–™

        ä½¿ç”¨ csv æ¨¡çµ„è¼¸å‡º CSV æª”

    åœ¨ orders.html ä¸­æ–°å¢žæŒ‰éˆ•ï¼š

        ã€ŒåŒ¯å‡ºå ±è¡¨ï¼ˆCSVï¼‰ã€æŒ‰éˆ•

        æŒ‰ä¸‹åŽ»æœƒé–‹å•Ÿ /export_csv?... å°æ‡‰çš„ä¸‹è¼‰é€£çµ

ðŸ”§ æ­¥é©Ÿä¸€ï¼šå»ºç«‹åŒ¯å‡ºè·¯ç”± /export_csv

æˆ‘å€‘æœƒå»ºç«‹ä¸€å€‹å’Œ /orders åŠŸèƒ½å¹¾ä¹Žä¸€æ¨£çš„ Flask è·¯ç”±ï¼Œåªæ˜¯æœ€å¾Œä¸æ˜¯ render_template()ï¼Œè€Œæ˜¯è¼¸å‡ºä¸€å€‹ CSV æª”æ¡ˆã€‚
âœ… Step 1ï¼šåœ¨ app.py åŠ ä¸Š /export_csv è·¯ç”±

from flask import Flask, render_template, request, Response
from models import session, Order, Customer
from datetime import datetime
import csv
from io import StringIO

app = Flask(__name__)

# ... ä½ åŽŸæœ¬çš„ /orders è·¯ç”±ä¿ç•™

@app.route("/export_csv")
def export_csv():
    customer_name = request.args.get("customer")
    start_date = request.args.get("start")
    end_date = request.args.get("end")

    query = session.query(Order)

    if customer_name:
        query = query.join(Order.customer).filter(Customer.name == customer_name)

    if start_date:
        start_dt = datetime.strptime(start_date, "%Y-%m-%d")
        query = query.filter(Order.order_date >= start_dt)

    if end_date:
        end_dt = datetime.strptime(end_date, "%Y-%m-%d")
        query = query.filter(Order.order_date <= end_dt)

    orders = query.all()

    # å¯«å…¥ CSV å­—ä¸²
    output = StringIO()
    writer = csv.writer(output)
    writer.writerow(["é¡§å®¢åç¨±", "å•†å“åç¨±", "å–®åƒ¹", "æ•¸é‡", "ç¸½é‡‘é¡", "è¨‚å–®æ—¥æœŸ"])

    for order in orders:
        writer.writerow([
            order.customer.name,
            order.product.name,
            order.product.price,
            order.quantity,
            order.quantity * order.product.price,
            order.order_date.strftime("%Y-%m-%d")
        ])

    # å›žå‚³ä¸‹è¼‰æª”æ¡ˆ
    response = Response(output.getvalue(), content_type="text/csv")
    response.headers["Content-Disposition"] = "attachment; filename=orders.csv"
    return response

âœ… Step 2ï¼šåœ¨ orders.html è£¡åŠ å…¥ã€ŒåŒ¯å‡ºå ±è¡¨ã€é€£çµ

ä½ å¯ä»¥åœ¨æœå°‹è¡¨å–®ä¸‹æ–¹åŠ é€™ä¸€æ®µæŒ‰éˆ•æˆ–é€£çµï¼š

<form method="get" action="/export_csv">
    <input type="hidden" name="customer" value="{{ request.args.get('customer', '') }}">
    <input type="hidden" name="start" value="{{ request.args.get('start', '') }}">
    <input type="hidden" name="end" value="{{ request.args.get('end', '') }}">
    <button type="submit">åŒ¯å‡ºå ±è¡¨ï¼ˆCSVï¼‰</button>
</form>

ðŸ” èªªæ˜Žï¼š

    é€™å€‹è¡¨å–®æœƒè‡ªå‹•æŠŠä½ ç›®å‰æŸ¥è©¢ç”¨çš„åƒæ•¸ä¹Ÿä¸€èµ·å¸¶åˆ° /export_csvï¼Œè®“ä½ åŒ¯å‡ºçš„å ±è¡¨å…§å®¹å°±æ˜¯ä½ ç¾åœ¨çœ‹åˆ°çš„è³‡æ–™ã€‚

    ä½¿ç”¨ StringIO æ¨¡æ“¬ä¸€å€‹è¨˜æ†¶é«”ä¸­çš„æª”æ¡ˆï¼Œè®“ Flask å›žå‚³ç‚ºä¸‹è¼‰æª”æ¡ˆã€‚

ðŸ§ª æ¸¬è©¦æ–¹æ³•ï¼š

    å…ˆåœ¨ /orders åšé—œéµå­—æˆ–æ—¥æœŸç¯©é¸

    æŒ‰ä¸‹ã€ŒåŒ¯å‡ºå ±è¡¨ï¼ˆCSVï¼‰ã€æŒ‰éˆ•

    ä¸‹è¼‰çš„æª”æ¡ˆæ‡‰è©²å°±æ˜¯ç›®å‰ç•«é¢ä¸Šçœ‹åˆ°çš„è³‡æ–™

ChatGPT èªªï¼š

éžå¸¸å¥½çš„è§€å¯Ÿ ðŸ‘
ä½ èªªå¾—å®Œå…¨æ­£ç¢ºï¼š/export_csv å’Œ /orders ä¹‹é–“æœ‰å¤§é‡ é‡è¤‡çš„æŸ¥è©¢é‚è¼¯ï¼Œé€™æ­£æ˜¯å¯¦å‹™ä¸­å¸¸è¦‹çš„ã€Œé‡æ§‹ã€æ™‚æ©Ÿã€‚
âœ… è§£æ³•ï¼šæŠ½å‡ºå…±ç”¨çš„æŸ¥è©¢é‚è¼¯ç‚ºä¸€å€‹ç¨ç«‹å‡½å¼
ðŸ“¦ 1. å»ºç«‹ä¸€å€‹å‡½å¼ï¼šget_filtered_orders()

é€™å€‹å‡½å¼æœƒçµ±ä¸€è™•ç†æŸ¥è©¢æ¢ä»¶é‚è¼¯ï¼Œä¸¦å›žå‚³æŸ¥è©¢çµæžœï¼š

def get_filtered_orders():
    customer_name = request.args.get("customer")
    start_date = request.args.get("start")
    end_date = request.args.get("end")

    query = session.query(Order)

    if customer_name:
        query = query.join(Order.customer).filter(Customer.name == customer_name)

    if start_date:
        start_dt = datetime.strptime(start_date, "%Y-%m-%d")
        query = query.filter(Order.order_date >= start_dt)

    if end_date:
        end_dt = datetime.strptime(end_date, "%Y-%m-%d")
        query = query.filter(Order.order_date <= end_dt)

    return query.all()

ðŸ“ 2. ä¿®æ”¹ /orders èˆ‡ /export_csv è·¯ç”±ä½¿ç”¨é€™å€‹å‡½å¼

@app.route("/orders")
def show_orders():
    orders = get_filtered_orders()
    return render_template("orders.html", orders=orders)


@app.route("/export_csv")
def export_csv():
    orders = get_filtered_orders()

    output = StringIO()
    writer = csv.writer(output)
    writer.writerow(["é¡§å®¢åç¨±", "å•†å“åç¨±", "å–®åƒ¹", "æ•¸é‡", "ç¸½é‡‘é¡", "è¨‚å–®æ—¥æœŸ"])

    for order in orders:
        writer.writerow([
            order.customer.name,
            order.product.name,
            order.product.price,
            order.quantity,
            order.quantity * order.product.price,
            order.order_date.strftime("%Y-%m-%d")
        ])

    response = Response(output.getvalue(), content_type="text/csv")
    response.headers["Content-Disposition"] = "attachment; filename=orders.csv"
    return response

âœ… å„ªé»ž

    é‡è¤‡é‚è¼¯åªå¯«ä¸€æ¬¡ï¼Œæ›´å¥½ç¶­è­·

    æœªä¾†å¦‚æžœæŸ¥è©¢æ¢ä»¶é‚è¼¯éœ€è¦ä¿®æ”¹ï¼Œåªè¦æ”¹ get_filtered_orders() ä¸€å€‹åœ°æ–¹å°±å¥½

    çµæ§‹æ›´æ¸…æ™°ï¼Œæ–¹ä¾¿ä½ è‡ªå·±å’Œä»–äººç†è§£

    ðŸ§  StringIO() æ˜¯ä»€éº¼ï¼Ÿ

StringIO ä¾†è‡ª io æ¨¡çµ„ï¼Œæ˜¯ä¸€ç¨® åœ¨è¨˜æ†¶é«”ä¸­æ¨¡æ“¬æª”æ¡ˆæ“ä½œçš„ç‰©ä»¶ã€‚ä½ å¯ä»¥æŠŠå®ƒæƒ³æˆä¸€ä»½ã€Œå‡çš„æª”æ¡ˆã€ï¼Œå¯ä»¥ write()ã€read()ï¼Œä½†å¯¦éš›ä¸Šå®ƒä¸¦ä¸æœƒå¯«å…¥ç¡¬ç¢Ÿï¼Œè€Œæ˜¯å­˜åœ¨è¨˜æ†¶é«”è£¡ã€‚
ðŸ“¦ ç‚ºä»€éº¼ Flask åŒ¯å‡º CSV è¦ç”¨å®ƒï¼Ÿ

å› ç‚ºä½ åœ¨ /export_csv è£¡æ˜¯è¦è®“ä½¿ç”¨è€… ç›´æŽ¥ä¸‹è¼‰æª”æ¡ˆï¼Œä¸éœ€è¦çœŸçš„æŠŠæª”æ¡ˆå¯«å…¥ç¡¬ç¢Ÿã€‚é€™æ™‚å€™å°±å¾ˆé©åˆä½¿ç”¨ StringIO() ä¾†ï¼š

    å»ºç«‹ä¸€å€‹è¨˜æ†¶é«”ä¸­çš„æª”æ¡ˆå®¹å™¨

    æŠŠè³‡æ–™å¯«é€²åŽ»ï¼ˆç”¨ csv.writer(output)ï¼‰

    å°‡é€™å€‹è³‡æ–™å…§å®¹ä½œç‚ºå›žæ‡‰å‚³çµ¦ä½¿ç”¨è€…ä¸‹è¼‰ï¼ˆç”¨ response = Response(output.getvalue(), ...)ï¼‰

ðŸ” å°ç…§ç¯„ä¾‹èªªæ˜Žï¼š

from io import StringIO
import csv

output = StringIO()                      # å»ºç«‹ä¸€å€‹ã€Œè¨˜æ†¶é«”ä¸­çš„æª”æ¡ˆã€
writer = csv.writer(output)             # ä½¿ç”¨ csv å¯«å…¥å™¨ï¼ŒæŠŠè³‡æ–™å¯«é€²é€™å€‹ output

writer.writerow(["å§“å", "å•†å“", "æ•¸é‡"])   # å¯«å…¥æ¨™é¡Œ
writer.writerow(["å°æ˜Ž", "è€³æ©Ÿ", 2])       # å¯«å…¥ä¸€ç­†è³‡æ–™

csv_string = output.getvalue()          # æŠŠæ•´å€‹æª”æ¡ˆå…§å®¹å–å‡ºï¼ˆå­—ä¸²æ ¼å¼ï¼‰

é€™æ¨£å°±ä¸éœ€è¦çœŸæ­£ç”¢ç”Ÿä¸€å€‹ xxx.csv æª”æ¡ˆï¼Œä¹Ÿèƒ½æä¾›ä¸‹è¼‰ã€‚
âœ… æœ€å¾Œç”¨é€”ï¼ˆçµåˆ Flaskï¼‰

ä½ æŠŠ csv_string æ”¾é€² Flask å›žå‚³ï¼š

from flask import Response

response = Response(csv_string, content_type="text/csv")
response.headers["Content-Disposition"] = "attachment; filename=orders.csv"
return response

ä½¿ç”¨è€…é»žæ“Šç¶²å€å°±èƒ½ä¸‹è¼‰é€™å€‹ CSV æª”ã€‚