âœ… æ•´é«”é‚è¼¯å›é¡§

ä½ ç›®å‰å®Œæˆäº†ï¼š

    ä½¿ç”¨ SQLAlchemy å®šç¾© Product, Customer, Order ä¸‰å€‹è³‡æ–™è¡¨

    æ­£ç¢ºå‘¼å« Base.metadata.create_all(engine) ä¾†å»ºè¡¨

    å·²æº–å‚™å¥½ Session é€£ç·š

ğŸ”§ å»ºè­°ä¿®æ­£èˆ‡å¼·åŒ–ï¼ˆéå¸¸é‡è¦ï¼‰
1ï¸âƒ£ Order çš„ customer_id å’Œ product_id æ‡‰è©²æ˜¯æ•´æ•¸ä¸¦åŠ ä¸Šé—œè¯

from sqlalchemy import ForeignKey

class Order(Base):
    __tablename__ = "order"
    id = Column(Integer, primary_key=True)
    customer_id = Column(Integer, ForeignKey("customer.id"))
    product_id = Column(Integer, ForeignKey("product.id"))
    quantity = Column(Integer)
    order_date = Column(String)

ğŸ“Œ ä½¿ç”¨ ForeignKey("è¡¨å.æ¬„ä½å") æ˜¯ ORM é—œè¯çš„é‡è¦åŸºç¤ã€‚
2ï¸âƒ£ å¯åŠ ä¸Š relationshipï¼ˆå¯ç­‰å¾ŒçºŒå†åŠ ï¼Œç¾åœ¨ä¹Ÿå¯ä»¥å‚™å¥½ï¼‰

å¦‚æœä½ æœªä¾†è¦å¾è¨‚å–®ç›´æ¥å–å¾— order.customer.name æˆ– order.product.nameï¼Œå¯é€™æ¨£åŠ ï¼š

from sqlalchemy.orm import relationship

class Customer(Base):
    __tablename__ = "customer"
    id = Column(Integer, primary_key=True)
    name = Column(String)
    email = Column(String)
    orders = relationship("Order", backref="customer")

class Product(Base):
    __tablename__ = "product"
    id = Column(Integer, primary_key=True)
    name = Column(String)
    price = Column(Integer)
    orders = relationship("Order", backref="product")

é€™æ¨£ä½ åœ¨æŸ¥è©¢è¨‚å–®æ™‚å°±å¯ä»¥ç”¨ï¼š

order.customer.name
order.product.name

3ï¸âƒ£ å¯ç§»é™¤ sqlite3ï¼ˆä½ ç›®å‰å®Œå…¨æ²’ç”¨åˆ°ï¼‰
âœ… ä¿®æ­£å¾Œçš„ models.pyï¼ˆä½ å¯ç›´æ¥è²¼ä¸Šè¦†è“‹ï¼‰

from sqlalchemy import create_engine, Column, Integer, String, ForeignKey
from sqlalchemy.orm import declarative_base, relationship, sessionmaker

engine = create_engine("sqlite:///database.db")
Base = declarative_base()

class Product(Base):
    __tablename__ = "product"
    id = Column(Integer, primary_key=True)
    name = Column(String)
    price = Column(Integer)
    orders = relationship("Order", backref="product")

class Customer(Base):
    __tablename__ = "customer"
    id = Column(Integer, primary_key=True)
    name = Column(String)
    email = Column(String)
    orders = relationship("Order", backref="customer")

class Order(Base):
    __tablename__ = "order"
    id = Column(Integer, primary_key=True)
    customer_id = Column(Integer, ForeignKey("customer.id"))
    product_id = Column(Integer, ForeignKey("product.id"))
    quantity = Column(Integer)
    order_date = Column(String)

Base.metadata.create_all(engine)

Session = sessionmaker(bind=engine)
session = Session()

ä½ å®Œæˆé€™å€‹æ­¥é©Ÿå¾Œ âœ…
è«‹å‘Šè¨´æˆ‘ä½ æ˜¯å¦æˆåŠŸåŸ·è¡Œï¼Œè³‡æ–™åº«æœ‰ç”¢ç”Ÿä¸‰å¼µè¡¨ï¼Œæˆ‘å°±è®“ä½ é€²å…¥ ä¸‹ä¸€æ­¥ï¼šæ’å…¥å‡è³‡æ–™ï¼ˆDay 19 ç¬¬äºŒéšæ®µï¼‰ï¼éœ€è¦çš„è©±æˆ‘ä¹Ÿå¯ä»¥å¹«ä½ åšè³‡æ–™æª¢æŸ¥æŒ‡ä»¤ã€‚
ä½ èªªï¼š

name = Column(String)
é€™äº›å‰é¢éƒ½ä¸éœ€è¦çµ¦"name"å—
ChatGPT èªªï¼š

å¾ˆå¥½çš„å•é¡Œï¼
âœ… å›ç­”ï¼š

åœ¨é€™æ¨£çš„å¯«æ³•ä¸­ï¼š

name = Column(String)

é€™æ˜¯å®Œå…¨ åˆæ³•ä¸”æ¨è–¦çš„å¯«æ³•ï¼Œå› ç‚º SQLAlchemy é è¨­æœƒä½¿ç”¨ã€ŒPython å±¬æ€§çš„åå­—ã€ä½œç‚ºè³‡æ–™è¡¨çš„æ¬„ä½åç¨±ã€‚
ğŸ“Œ æ‰€ä»¥é€™å…©ç¨®å¯«æ³•å…¶å¯¦æ˜¯ç­‰åƒ¹çš„ï¼š
ç²¾ç°¡å¯«æ³•	æ˜ç¢ºå¯«æ³•
name = Column(String)	name = Column("name", String)
price = Column(Integer)	price = Column("price", Integer)
âœ… å»ºè­°ä½¿ç”¨çš„å¯«æ³•ï¼š

åœ¨å¤§å¤šæ•¸æƒ…æ³ä¸‹ï¼ˆæ¬„ä½åç¨±èˆ‡è®Šæ•¸åä¸€è‡´ï¼‰ï¼Œå»ºè­°ä½¿ç”¨ï¼š

name = Column(String)

é™¤éï¼š

    æ¬„ä½åç¨±èˆ‡ Python ä¿ç•™å­—è¡çªï¼ˆä¾‹å¦‚ä½ è¦å‘½åæˆ classï¼‰

    æ¬„ä½åœ¨è³‡æ–™åº«ä¸­çš„åç¨±å’Œ Python ä¸­æƒ³ç”¨çš„è®Šæ•¸åä¸åŒ

æ‰éœ€è¦åŠ  "æ¬„ä½å" åƒæ•¸ï¼š

class_ = Column("class", String)

ğŸ§  å°çµï¼š

    ä½ ç›®å‰çš„é€™ç¨®ç°¡æ½”å¯«æ³•æ˜¯æ­£ç¢ºä¸”æ¨è–¦çš„ âœ…

    å‰é¢é‚£ç¨® name = Column("name", String) æ˜¯å¤šé¤˜çš„ï¼Œä¸éŒ¯ä½†æ²’å¿…è¦

ä½ å¯ä»¥æ”¾å¿ƒåˆªæ‰ "name" é€™äº›å­—ä¸²åƒæ•¸ï¼Œè®“ç¨‹å¼ç¢¼æ›´ç°¡æ½”ï¼

æ˜¯å¦è¦é€²å…¥ã€Œæ’å…¥å‡è³‡æ–™ã€çš„ä¸‹ä¸€éšæ®µï¼Ÿæˆ‘å¯ä»¥çµ¦ä½ ä»»å‹™æ•˜è¿°æˆ–è®“ä½ è‡ªå·±å˜—è©¦ã€‚
ä½ èªªï¼š

orders = relationship("Order", backref="product")
æˆ‘æ³¨æ„åˆ°ä½ é€™é‚Šçš„Oæ˜¯å¤§å¯« é€™è£¡çš„å¤§å°å¯«æœ‰å€åˆ¥å—? é‚„æœ‰é€™å€‹çš„åŸç†æ˜¯ä»€éº¼ ä»–å¾Œé¢æœƒæ€éº¼é—œè¯?
ChatGPT èªªï¼š

ä½ è§€å¯Ÿå¾—éå¸¸ç²¾æº– ğŸ‘€
é€™è£¡çš„ relationship("Order", backref="product") è£¡çš„ "Order" çš„ å¤§å°å¯«æ˜¯æœ‰å€åˆ¥çš„ï¼Œè€Œä¸”å®ƒèƒŒå¾Œçš„åŸç†ä¹Ÿéå¸¸å€¼å¾—æ·±å…¥ç†è§£ï¼Œä»¥ä¸‹å¹«ä½ å®Œæ•´æ‹†è§£ã€‚
âœ… ä¸€ã€å¤§å°å¯«æœ‰æ²’æœ‰å€åˆ¥ï¼Ÿ

æ˜¯çš„ï¼Œæœ‰å€åˆ¥ã€‚

orders = relationship("Order", backref="product")

é€™è£¡çš„ "Order" æ˜¯ SQLAlchemy é€éå­—ä¸²å°‹æ‰¾é¡åˆ¥åç¨±çš„æ–¹å¼ï¼Œå¿…é ˆå®Œå…¨åŒ¹é…ï¼š

    ä½ ä¸Šé¢å®šç¾©çš„æ˜¯ class Order(...) ğŸ‘‰ æ‰€ä»¥é€™è£¡å¿…é ˆå¯« "Order"ï¼ˆå¤§å¯« Oï¼‰

    å¦‚æœä½ å¯«æˆ "order"ï¼ˆå°å¯«ï¼‰ï¼Œæœƒæ‰¾ä¸åˆ°å°æ‡‰çš„é¡åˆ¥ï¼Œå°è‡´éŒ¯èª¤ï¼š

    sqlalchemy.exc.InvalidRequestError: When initializing mapper ... could not locate a class named 'order'.

âœ… çµè«–ï¼šè¦è·Ÿ class åç¨±å®Œå…¨ä¸€æ¨£ï¼Œå¤§å°å¯«æœ‰å·®
âœ… äºŒã€å®ƒçš„åŸç†æ˜¯ä»€éº¼ï¼Ÿ

é€™å¥ï¼š

orders = relationship("Order", backref="product")

æ˜¯åœ¨å‘Šè¨´ SQLAlchemyï¼š

    ã€Œæˆ‘é€™å€‹ Customerï¼ˆæˆ– Productï¼‰ç‰©ä»¶ï¼Œå¯ä»¥é€é relationship å±¬æ€§ï¼Œå–å¾—èˆ‡å®ƒç›¸é—œçš„ Order è³‡æ–™ã€‚ã€

ğŸ§  èˆ‰ä¾‹ï¼š

ä½ å®šç¾©äº†é€™æ¨£çš„é—œè¯ï¼š

class Product(Base):
    ...
    orders = relationship("Order", backref="product")

SQLAlchemy å¹«ä½ å»ºç«‹äº†é›™å‘é—œè¯ï¼š
åœ¨ Product è£¡ï¼š

    product.orders ğŸ‘‰ å¯ä»¥æ‹¿åˆ°æ‰€æœ‰è¨‚è³¼é€™å€‹å•†å“çš„ Order åˆ—è¡¨

åœ¨ Order è£¡ï¼š

    order.product ğŸ‘‰ è‡ªå‹•å»ºç«‹ï¼Œè®“ä½ å¯ä»¥é€é backref="product" æ‹¿åˆ°é€™ç­†è¨‚å–®æ‰€å°æ‡‰çš„ Product ç‰©ä»¶ï¼ˆé€™æ˜¯é‡é»ï¼‰

ğŸ“¦ ç°¡å–®åœ–ç¤ºï¼š

Product â†â”€â”€â”€â”
            â”‚
      product.orders â†’ [Order, Order, ...]
            â†‘
        order.productï¼ˆè‡ªå‹•å»ºç«‹ï¼‰

âœ… ä¸‰ã€å»¶ä¼¸å°æŠ€å·§ï¼šç”¨ back_populates å¯æ›´ç´°æ§åˆ¶

å¦‚æœä½ æƒ³é›™é‚Šéƒ½æ˜ç¢ºå¯«å‡ºä¾†ï¼ˆå–ä»£ backrefï¼‰ï¼Œå¯ä»¥ç”¨ï¼š

class Product(Base):
    ...
    orders = relationship("Order", back_populates="product")

class Order(Base):
    ...
    product = relationship("Product", back_populates="orders")

åŠŸèƒ½è·Ÿ backref ä¸€æ¨£ï¼Œä½†çµæ§‹æ›´æ¸…æ¥šã€ä¾¿æ–¼å¤§å‹å°ˆæ¡ˆç¶­è­·ã€‚

ğŸ” å°è£œå……ï¼ˆéå¿…é ˆï¼‰ï¼š

è‹¥æœªä¾†ä½ æƒ³è®“ order_date æ”¯æ´æ›´ç²¾ç¢ºçš„æ™‚é–“é‹ç®—ï¼Œå¯ä»¥ç”¨ï¼š

from sqlalchemy import DateTime
from datetime import datetime

order_date = Column(DateTime, default=datetime.now)

ç›®å‰ä½¿ç”¨ String æ²’éŒ¯ï¼Œå¾Œé¢è¦ç·´ç¿’æ™‚é–“éæ¿¾æŸ¥è©¢å†æ”¹ä¹Ÿå¯ä»¥ã€‚
âœ… ç¸½çµ
é …ç›®	èªªæ˜
relationship("Order", backref="product")	å»ºç«‹é›™å‘é—œè¯ï¼šProduct æœ‰å¤šå€‹ Orderï¼ŒOrder å¯åæŸ¥ Product
"Order" å­—ä¸²	å¿…é ˆèˆ‡ class åç¨±å®Œå…¨ç›¸åŒï¼Œå¤§å°å¯«æœ‰åˆ¥
backref="product"	è®“ Order é¡åˆ¥è‡ªå‹•æ“æœ‰ .product å±¬æ€§
æ›¿ä»£æ–¹æ¡ˆ	back_populates æ›´æ˜ç¢ºã€é›™é‚Šå®šç¾©ï¼Œé©åˆè¤‡é›œå°ˆæ¡ˆ

âœ… çµè«–ï¼šä½ çš„ models.py å¯ä»¥ç›´æ¥é€²å…¥ Alembic migration éšæ®µï¼

è«‹ä¾ç…§ä»¥ä¸‹æ­¥é©Ÿæ“ä½œï¼š
ğŸ§­ Alembic Migration å»ºè¡¨æ­¥é©Ÿï¼ˆSQLiteï¼‰
æ­¥é©Ÿ 1ï¼šåˆå§‹åŒ– Alembicï¼ˆåªéœ€åšä¸€æ¬¡ï¼‰

alembic init alembic

æ­¥é©Ÿ 2ï¼šç·¨è¼¯ alembic/env.py

æ‰¾åˆ°é€™æ®µï¼ˆå¤§ç´„åœ¨ 38 è¡Œé™„è¿‘ï¼‰ï¼š

# target_metadata = None

æ”¹æˆï¼š

from your_module.models import Base  # â† ä½ çš„ models.py è·¯å¾‘

target_metadata = Base.metadata

ä¾‹å¦‚ä½ çš„ models.py è·¯å¾‘æ˜¯ï¼š

course_exercise_simple/course_exercise/models.py

ä½ å¯èƒ½éœ€è¦æ”¹æˆï¼š

from course_exercise.models import Base

æ­¥é©Ÿ 3ï¼šç”¢ç”Ÿ migration æª”

alembic revision --autogenerate -m "Create tables"

æ­¥é©Ÿ 4ï¼šå¥—ç”¨ migrationï¼ˆçœŸæ­£å»ºè¡¨ï¼‰

alembic upgrade head

å®Œæˆå¾Œä½ å¯ä»¥ä½¿ç”¨ SQLite ç€è¦½å™¨æˆ– SQLAlchemy æŸ¥è©¢ä¸‰å¼µè¡¨æ˜¯å¦å»ºç«‹æˆåŠŸã€‚